# 🔍 Netlify 数据丢失问题排查指南

## ⚠️ 问题描述

在 Netlify 部署的网站上导入数据后，关闭浏览器再打开，导入的点位数据消失了。

## 🔍 可能的原因

### 1. 使用了无痕/隐私模式 ⭐⭐⭐（最可能）

**症状**：
- 使用了浏览器的无痕模式（Incognito/InPrivate）
- 关闭标签页后数据自动清除

**解决方案**：
- ✅ 使用正常模式访问网站（不要使用无痕模式）
- ✅ 在正常模式下重新导入数据

**如何检查**：
- Chrome/Edge：查看地址栏是否有"无痕"图标
- 或查看浏览器窗口是否有"您正在使用无痕模式"提示

---

### 2. 浏览器自动清除设置 ⭐⭐

**症状**：
- 浏览器设置了"退出时清除 Cookie 和网站数据"
- 每次关闭浏览器都会清除 localStorage

**检查方法**：

**Chrome/Edge**：
1. 设置 → 隐私和安全 → 清除浏览数据
2. 点击"高级"标签
3. 检查是否勾选了"Cookie 和其他网站数据"
4. 查看"清除浏览数据"的时间范围设置

**解决方案**：
- 取消勾选"退出时清除 Cookie 和网站数据"
- 或排除您的 Netlify 网站域名

---

### 3. 浏览器扩展干扰 ⭐

**症状**：
- 安装了隐私保护扩展（如 AdBlock Plus、uBlock Origin 等）
- 扩展可能自动清除 localStorage

**检查方法**：
1. 暂时禁用所有浏览器扩展
2. 重新导入数据测试
3. 如果数据能保留，逐个启用扩展找出问题扩展

**解决方案**：
- 在扩展设置中，将您的 Netlify 网站添加到白名单

---

### 4. localStorage 被禁用 ⭐

**症状**：
- 浏览器或公司网络策略禁用了 localStorage
- 保存操作静默失败

**检查方法**：
打开浏览器控制台（F12），运行：

```javascript
// 测试 localStorage 是否可用
try {
  localStorage.setItem('test', 'test')
  const value = localStorage.getItem('test')
  localStorage.removeItem('test')
  if (value === 'test') {
    console.log('✅ localStorage 可用')
  } else {
    console.log('❌ localStorage 测试失败')
  }
} catch (e) {
  console.error('❌ localStorage 被禁用:', e)
}
```

**解决方案**：
- 如果是公司/学校网络，联系管理员
- 如果是个人设置，检查浏览器隐私设置

---

### 5. 域名/IP 变化 ⭐

**症状**：
- Netlify 部署后，域名可能发生变化
- 使用了不同的子域名或路径

**检查方法**：
1. 查看浏览器地址栏的完整 URL
2. 确认每次访问的是同一个域名
3. localStorage 是基于完整域名存储的

**示例**：
```
❌ https://your-app.netlify.app      → 存储 A
❌ https://www.your-app.netlify.app  → 存储 B（不同！）
❌ http://your-app.netlify.app      → 存储 C（不同！）
```

**解决方案**：
- 确保每次都使用相同的完整 URL 访问
- 建议使用书签保存固定地址

---

### 6. HTTPS 证书问题 ⭐

**症状**：
- 浏览器显示"不安全连接"
- localStorage 可能被阻止

**解决方案**：
- Netlify 会自动提供 HTTPS，确保使用 HTTPS 访问
- 不要在"不安全"警告下继续访问

---

## 🛠️ 诊断步骤

### 步骤 1：检查数据是否真的保存了

在导入数据后，立即打开浏览器控制台（F12），运行：

```javascript
// 检查数据是否在 localStorage 中
const data = localStorage.getItem('user_data_sets')
if (data) {
  console.log('✅ 数据存在，大小:', (data.length / 1024).toFixed(2), 'KB')
  const parsed = JSON.parse(data)
  console.log('✅ 数据集数量:', parsed.dataSets.length)
  parsed.dataSets.forEach((ds, i) => {
    console.log(`  数据集 ${i + 1}: ${ds.name} (${ds.points.length} 个点)`)
  })
} else {
  console.log('❌ 没有找到数据！')
}
```

### 步骤 2：关闭浏览器前再次检查

在关闭浏览器前，再次运行上面的代码，确认数据仍在。

### 步骤 3：重新打开后检查

重新打开浏览器和网站，再次运行检查代码，看看数据是否还在。

### 步骤 4：查看浏览器控制台日志

导入数据时，查看控制台是否有：
- ✅ "数据已保存并验证成功"
- ❌ "保存验证失败" 或任何错误信息

---

## ✅ 解决方案

### 方案 1：使用正常模式（推荐）

1. **确保不使用无痕模式**
2. **检查浏览器清除设置**
   - Chrome/Edge：设置 → 隐私和安全 → 清除浏览数据 → 高级
   - 确保没有勾选"退出时清除 Cookie 和网站数据"

### 方案 2：使用数据导出/导入功能（临时）

1. **导入数据后立即导出**
   - 使用"导出数据"功能下载备份文件
2. **重新打开后导入备份**
   - 使用"导入数据"功能恢复数据

### 方案 3：检查浏览器扩展

1. **禁用所有扩展**
2. **重新测试数据导入**
3. **如果问题解决，逐个启用扩展找出问题**

---

## 📊 诊断检查清单

导入数据后，请依次检查：

- [ ] 是否使用了无痕模式？（如果是，改为正常模式）
- [ ] 浏览器是否设置了"退出时清除数据"？（检查并取消）
- [ ] localStorage 是否可用？（运行测试代码）
- [ ] 控制台是否有保存成功日志？
- [ ] 导入后立即检查数据是否存在？
- [ ] 关闭浏览器前数据是否还在？
- [ ] 重新打开后数据是否还在？
- [ ] 是否安装了可能清除数据的扩展？

---

## 🚨 如果所有方法都无效

如果以上方法都无法解决问题，可能需要：

1. **使用云端存储方案**
   - 将数据存储在服务器上（需要后端）
   - 使用 Firebase、Supabase 等云服务

2. **联系技术支持**
   - 提供浏览器类型和版本
   - 提供控制台错误日志
   - 提供详细的复现步骤

---

## 💡 预防措施

1. **定期导出备份**
   - 导入数据后立即导出备份文件
   - 保存在安全的地方（本地或云端）

2. **使用固定域名**
   - 使用书签保存网站地址
   - 避免使用不同的域名或子域名访问

3. **检查浏览器设置**
   - 不要设置自动清除数据
   - 将网站添加到白名单

4. **避免使用无痕模式**
   - 无痕模式下数据不会持久保存
   - 使用正常模式访问网站

---

## 📝 报告问题时的信息

如果问题仍然存在，请提供以下信息：

1. **浏览器信息**
   - 浏览器类型（Chrome/Edge/Firefox/Safari）
   - 浏览器版本
   - 是否使用了无痕模式

2. **操作步骤**
   - 导入数据的详细步骤
   - 关闭浏览器的方式
   - 重新打开的方式

3. **控制台日志**
   - 导入时的控制台输出
   - 重新打开后的控制台输出
   - 任何错误信息

4. **诊断结果**
   - localStorage 测试结果
   - 数据检查结果
   - 浏览器设置检查结果

---

## 🎯 快速诊断命令

将以下代码保存为浏览器书签，导入数据后点击检查：

```javascript
javascript:(function(){
  const data = localStorage.getItem('user_data_sets');
  if (data) {
    const parsed = JSON.parse(data);
    alert(`✅ 数据存在！\n\n数据集数量: ${parsed.dataSets.length}\n总数据点: ${parsed.dataSets.reduce((sum, ds) => sum + ds.points.length, 0)}\n数据大小: ${(data.length / 1024).toFixed(2)} KB`);
  } else {
    alert('❌ 没有找到数据！\n\n可能原因：\n1. 使用了无痕模式\n2. 浏览器清除了数据\n3. 数据未正确保存');
  }
})();
```

使用方法：
1. 复制上面的代码
2. 创建浏览器书签，URL 填入代码
3. 导入数据后点击书签检查
